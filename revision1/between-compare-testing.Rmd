---
title: "between-compare-testing"
author: "Bj√∂rn Siepe"
output: html_document
---
```{r}
library(here)
library(tidyverse)
library(BGGM)
library(tsnet)
library(mvtnorm)
library(tictoc)
source(here("aux_funs.R"))
```



# Revive the old functions
```{r}
postemp_distance <- function(post,
                             emp,
                             comp,
                             mod){

  # storage
  dist_out <- list()



  if(comp == "frob"){
    normtype = "F"
    frob_beta <- unlist(lapply(post[[mod]]$fit, function(x){
      if(length(x) == 0 | !is.list(x))
        {NA}
      else
        {norm(emp[[mod]]$beta_mu-x$beta_mu, type = normtype)}}))

    frob_pcor <- unlist(lapply(post[[mod]]$fit, function(x){
      if(length(x) == 0 | !is.list(x))
        {NA}
      else
        {norm(emp[[mod]]$pcor_mu-x$pcor_mu, type = normtype)}}))

    dist_out[["beta"]] <- frob_beta
    dist_out[["pcor"]] <- frob_pcor

    }  # end frob




  if(comp == "maxdiff"){
    maxdiff_beta <- unlist(lapply(post[[mod]]$fit, function(x){
      if(length(x) == 0 | !is.list(x))
        {NA}
      else
        {max(abs(emp[[mod]]$beta_mu-x$beta_mu))}}))

    maxdiff_pcor <- unlist(lapply(post[[mod]]$fit, function(x){
      if(length(x) == 0 | !is.list(x))
        {NA}
      else
        {max(abs(emp[[mod]]$pcor_mu-x$pcor_mu))}}))

    dist_out[["beta"]] <- maxdiff_beta
    dist_out[["pcor"]] <- maxdiff_pcor

    }  # end maxdiff



  if(comp == "l1"){
    l1_beta <-  unlist(lapply(post[[mod]]$fit, function(x){
      if(length(x) == 0 | !is.list(x))
        {NA}
      else
        {sum(abs(emp[[mod]]$beta_mu-x$beta_mu))}}))

    l1_pcor <-  unlist(lapply(post[[mod]]$fit, function(x){
      if(length(x) == 0 | !is.list(x))
      {NA}
      else
      {sum(abs(emp[[mod]]$pcor_mu-x$pcor_mu))}}))

      dist_out[["beta"]] <- l1_beta
      dist_out[["pcor"]] <- l1_pcor


    }  # end l1

  if(comp == "pcmd"){
    # only suitable for (partial) correlations
    pcmd_pcor <-  unlist(lapply(post[[mod]]$fit, function(x){
      if(length(x) == 0 | !is.list(x))
      {NA}
      else
      {1 - (sum(diag(emp[[mod]]$pcor_mu %*% x$pcor_mu)) / (norm(emp[[mod]]$pcor_mu, type = "F") * norm(x$pcor_mu, type = "F")))}}))
    # dist_out[["beta"]] <- NULL
    dist_out[["pcor"]] <- pcmd_pcor


  }


  return(dist_out)
}



```


Create function to test the results: 
```{r}
test_between <- function(compare_res,
                         # Compute Bayes Factor?
                         bf = TRUE,
                         # Hypothesis for BF testing
                         bf_hyp_beta = NULL,
                         bf_hyp_pcor = NULL,
                         # Return all results?
                         return_all = TRUE,
                         # Further arguments to the BF function
                         ...
                         ){
  
  # browser()
  
  #--- Test Beta
  x <- compare_res$beta
  y <- compare_res$beta_ref
  
  test_beta <- bain::t_test(
         x = x,
         y = y, 
         paired = FALSE,
         var.equal = FALSE)
  
  #--- Test Pcor
  x <- compare_res$pcor
  y <- compare_res$pcor_ref
  
  test_pcor <- bain::t_test(
         x = x,
         y = y, 
         data = compare_res, 
         paired = FALSE,
         var.equal = FALSE)
  
  
  #--- Bayes Factors
  if(isTRUE(bf)){
    if(is.null(bf_hyp_beta)){
      bf_hyp_beta <- "difference = 0; difference > 0; difference < 0"
    }
    if(is.null(bf_hyp_pcor)){
      bf_hyp_pcor <- "difference = 0; difference > 0; difference < 0"
    }
    
    
    bf_beta <- BFpack::BF(test_beta,
                          hypothesis = bf_hyp_beta,
                          ...)
    bf_pcor <- BFpack::BF(test_pcor,
                          hypothesis = bf_hyp_pcor,
                          ...)
  }
  
  
  #--- Output
  if(isTRUE(return_all)){
  if(isTRUE(bf)){
    out <- list(
      bf_beta = bf_beta,
      bf_pcor = bf_pcor
    )
  } else{
    out <- list(
      beta = test_beta,
      pcor = test_pcor
    )
  }
  }
  
  if(isFALSE(return_all)){
    if(isTRUE(bf)){
      out <- list(
        beta_stat = beta$statistic,
        beta_est = beta$estimate,
        pcor_stat = pcor$statistic,
        pcor_est = pcor$estimate,
        bf_beta = bf_beta,
        bf_pcor = bf_pcor
      )
    } else{
      out <- list(
        beta = test_beta$p.value,
        pcor = test_pcor$p.value
      )
    }
  }
  
  return(out)
  
}


```






# Try them on an example
Fit model as in the tsnet example: 
```{r}
# Load data of two individuals
data <- BGGM::ifit
data_1 <- subset(data, id == 1)
data_3 <- subset(data, id == 3)
data_6 <- subset(data, id == 6)

# Estimate networks
# (should perform detrending etc. in a real use case)
net_1 <- BGGM::var_estimate(data_1[,-1],
                            rho_sd = 0.25, 
                            beta_sd = 0.5,
                            iter = 50000)
net_3 <- BGGM::var_estimate(data_3[,-1],
                            rho_sd = 0.25, 
                            beta_sd = 0.5,
                            iter = 50000)


# Use networks from simulation study
l_changed_graphs <-readRDS(here("data/l_changed_graphs_0305.RDS"))

# Simulate two datasets
net_1a <- graphicalVAR::graphicalVARsim(200,
                                       beta = l_changed_graphs$graph4$truegraph$beta,
                                       kappa = l_changed_graphs$graph4$truegraph$kappa)
net_1b <- graphicalVAR::graphicalVARsim(200,
                                       beta = l_changed_graphs$graph4$truegraph$beta,
                                       kappa = l_changed_graphs$graph4$truegraph$kappa)

net_2 <- graphicalVAR::graphicalVARsim(200,
                                       beta = l_changed_graphs$graph4$const0.05$beta,
                                       kappa = l_changed_graphs$graph4$const0.05$kappa)


net_3 <- graphicalVAR::graphicalVARsim(200,
                                       beta = l_changed_graphs$graph4$const0.15$beta,
                                       kappa = l_changed_graphs$graph4$const0.15$kappa)

# Estimate networks
# (should perform detrending etc. in a real use case)
r_net_1a <- BGGM::var_estimate(as.data.frame(net_1a),
                            rho_sd = 0.25, 
                            beta_sd = 0.5,
                            iter = 50000)
r_net_1b <- BGGM::var_estimate(as.data.frame(net_1b),
                            rho_sd = 0.25, 
                            beta_sd = 0.5,
                            iter = 50000)
r_net_2 <- BGGM::var_estimate(as.data.frame(net_2),
                            rho_sd = 0.25, 
                            beta_sd = 0.5,
                            iter = 50000)

r_net_3 <- BGGM::var_estimate(as.data.frame(net_3),
                            rho_sd = 0.25, 
                            beta_sd = 0.5,
                            iter = 50000)



```

Now do cross-comparison:
```{r}
# test <- post_distance_between(r_net_1, r_net_3, 
#                               comp = "l1", 
#                               draws = 1000)

cgb1ab <- compare_gvar_between(r_net_1a, r_net_1b, 
                              comp = "l1", 
                              n_draws = 100,
                              combine_post = TRUE,
                              sampling_method = "random",
                              burnin = 500)

cgb12 <- compare_gvar_between(r_net_1, r_net_2,
                              comp = "l1", 
                              n_draws = 100,
                              combine_post = TRUE,
                              sampling_method = "random",
                              burnin = 500)

cgb13 <- compare_gvar_between(r_net_1, r_net_3, 
                              comp = "l1", 
                              n_draws = 100,
                              combine_post = TRUE,
                              sampling_method = "random",
                              burnin = 500)

test_res1ab <- test_between(cgb1ab,
                         bf = TRUE,
                         complement = FALSE
                         )
test_res1ab_eq <- test_between(cgb1ab,
                         bf = TRUE,
                         bf_hyp_beta = "difference > 0.36; difference < 0.36",
                         bf_hyp_pcor = "difference > 0.15; difference < 0.15",
                         complement = FALSE)

# test_res1a2 <- test_between(cgb12,
#                          bf = TRUE,
#                          complement = FALSE
#                          # bf_hyp_eta = "difference > 0.36; difference < 0.36",
#                          # bf_hyp_pcor = "difference > 0.15; difference < 0.15"
#                          # 
#                          )

test_res1a2_eq <- test_between(cgb12,
                         bf = TRUE,
                         bf_hyp_beta = "difference > 0.36; difference < 0.36",
                         bf_hyp_pcor = "difference > 0.15; difference < 0.15",
                         complement = FALSE
                         )


# test_res13 <- test_between(cgb13,
#                          bf = TRUE,
#                          complement = FALSE
#                          # bf_hyp_eta = "difference > 0.36; difference < 0.36",
#                          # bf_hyp_pcor = "difference > 0.15; difference < 0.15"
#                          # 
#                          )
test_res13_eq <- test_between(cgb13,
                         bf = TRUE,
                         bf_hyp_beta = "difference > 0.36; difference < 0.36",
                         bf_hyp_pcor = "difference > 0.15; difference < 0.15",
                         complement = FALSE
                         )

```

```{r}


plot(density(test$beta))
plot(density(test$beta_ref))
plot(density(test$pcor))
```

As a benchmark, sample from the prior?
```{r}
# Partial correlations
p1_n1 <- BGGM::plot_prior(prior_sd = 0.25, iter = 10000 * 36)
prior_pcors_n1 <- p1_n1$plot_env$prior_samp$pcors[1,2,]
p1_n2 <- BGGM::plot_prior(prior_sd = 0.25, iter = 10000 * 36)
prior_pcors_n2 <- p1_n2$plot_env$prior_samp$pcors[1,2,]

# Betas
# p1_n1_reg <- rnorm(n = 36*10000, mean = 0, sd = 0.5)
# p1_n2_reg <- rnorm(n = 36*10000, mean = 0, sd = 0.5)



prior_beta_n1 <- array(p1_n1_reg, dim = c(6, 6, 10000))
prior_beta_n2 <- array(p1_n2_reg, dim = c(6, 6, 10000))
# double check
apply(prior_beta_n1, c(1,2), function(x) round(mean(x), digits = 2))
apply(prior_beta_n1, c(1,2), function(x) round(sd(x), digits = 2))

# Convert "prior_pcors_n1", a long numerical vector, to 10000 6x6 matrices
# store these in an array
prior_pcors_n1 <- array(prior_pcors_n1, dim = c(6, 6, 10000))
prior_pcors_n2 <- array(prior_pcors_n2, dim = c(6, 6, 10000))
# Set every matrix diagonal in this array to 0
for(i in 1:10000){
  diag(prior_pcors_n1[,,i]) <- 0
  diag(prior_pcors_n2[,,i]) <- 0
}


# Compute frobenius norm between the two arrays
frob_norm_pcor <- array(NA, dim = c(10000, 1))
frob_norm_beta <- array(NA, dim = c(10000, 1))
for(i in 1:10000){
  frob_norm_pcor[i] <- norm(prior_pcors_n1[,,i] - prior_pcors_n2[,,i], type = "F")
  frob_norm_beta[i] <- norm(prior_beta_n1[,,i] - prior_beta_n2[,,i], type = "F")
}

# Plot
plot(density(frob_norm_pcor))
plot(density(frob_norm_beta))

```

Compare the densities
```{r}
# Combine frob_norm and test$pcor into one dataframe
# label the values of each vector differently
# do it now
# Plot
plot(density(frob_norm_pcor), col = "red")
lines(density(test$pcor), col = "blue")

plot(density(frob_norm_beta), col = "red")
lines(density(test$beta), col = "blue")




```






