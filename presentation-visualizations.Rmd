---
title: "presentation-visualizations"
author: "Björn Siepe"
date: "`r Sys.Date()`"
output: html_document
---

In this document, visualizations for presentations about the VAR Compare project are generated.


# Prep
```{r}
library(tidyverse)
library(graphicalVAR)
library(doParallel)
library(doRNG)         
library(mgm)
library(mlVAR)
library(BGGM)
library(reshape2)      
library(mvtnorm)       
library(stats)         
source("aux_funs.R")
library(ggokabeito)
library(Matrix)
library(here)
library(rrapply)       
library(ggh4x)
here::i_am("var-compare.Rproj")


seed = 2022
set.seed(seed)
```


# Simulation 1
Load results
```{r}
# Evaluated simulation results for BGGM and GVAR
df_eval_gvar <- readRDS(here::here("output/df_eval_gvar_0705.RDS"))
df_eval_bggm <- readRDS(here::here("output/df_eval_bggm_0705.RDS"))
```

Summarize results and calculate standard errors for point estimates.
```{r}
# Number of repetitions
n_rep = 1000

## For GVAR
df_eval_gvar_mcse <- df_eval_gvar %>% 
   # pivot_longer, split beta and pcor
    pivot_longer(cols = -c(dgp_ind, tp_ind, lambda, ebic), 
               names_to = c(".value", "mat"), 
               names_pattern = "(.*)_([^_]+)$") %>% 
  dplyr::group_by(dgp_ind, tp_ind, lambda, ebic, mat) %>% 
  dplyr::summarize(
    bias = mean(bias), 
    bias_mcse = sqrt((1/(n_rep*(n_rep-1)))*sum(bias_sq)),  # double check the square here
    cor = mean(cor), 
    cor_mcse = sqrt(1-cor^2)/sqrt(n_rep-2),
    sens = mean(sens), 
    sens_mcse = sqrt((sens * (1-sens))/n_rep),
    spec = mean(spec),
    spec_mcse = sqrt((spec * (1-spec))/n_rep)) %>% 
  ungroup()


## For BGGM
df_eval_bggm_mcse <- df_eval_bggm %>% 
  # pivot_longer, split beta and pcor
  tidyr::pivot_longer(cols = -c(dgp_ind, tp_ind, rho_prior, beta_prior,
                           contains("ci")), 
               names_to = c(".value", "mat"), 
               names_pattern = "(.*)_([^_]+)$") %>% 

  rename(bias_bggm = bias, 
         rmse_bggm = rmse, 
         cor_bggm = cor) %>% 
    pivot_longer(
    cols = c(bias_bggm, # Specify the columns to pivot
             rmse_bggm, 
             cor_bggm, 
             bias_sel, 
             rmse_sel, 
             cor_sel),  
    names_to = c(".value", "method"),  # Specify the new column names
    names_pattern = "(.*)_(.*)"  # Pattern to match the column names
  ) %>% 
  dplyr::group_by(dgp_ind, tp_ind, rho_prior, beta_prior, mat, method) %>% 
  dplyr::summarize(
    bias = mean(bias), 
    bias_mcse = sqrt((1/(n_rep*(n_rep-1)))*sum(bias_sq)),
    cor = mean(cor), 
    cor_mcse = sqrt(1-cor^2)/sqrt(n_rep-2),
    sens = mean(sens), 
    sens_mcse = sqrt((sens * (1-sens))/n_rep),
    spec = mean(spec),
    spec_mcse = sqrt((spec * (1-spec))/n_rep)) %>% 
  ungroup()

```


Combine evaluations of BGGM and graphicalVAR
```{r}
# For joining, select one of the prior conditions
df_eval_both <- df_eval_bggm_mcse %>% 
  # filter(beta_prior == 0.5 & rho_prior == 0.5) %>% 
  left_join(df_eval_gvar_mcse, by = c("dgp_ind", "tp_ind", "mat"),
            suffix = c("_bggm", "_gvar")) %>% 
  ungroup() %>% 
  # selection vs. nonselection pivot wider
  pivot_wider(
    names_from = method, 
    values_from = c(contains("bggm")),
    names_sep = "_"
  ) %>% 
    rename_with(~ gsub("_bggm_", "_", .), contains("_bggm_"))

```


Prepare plotting. 
```{r}
# Timepoint values with all levels
tp_levels <- c("50" = "1", "100" = "2", "200" = "3", "400" = "4", "1000" = "5")

# DGP cut: should old dgps be cut? then set this to 2
# if not, set to 0
dgp_cut <- 2

# DGP Names
dgp_levels <- c("Old1" = "1", "Old2" = "2", "Empirical\nSparse" = "3",
                 "Simulated\nChain 6N" = "4", "Simulated\nNonsparse" = "5",
                 "Simulated\nChain 8N" = "6")

# With deleting old DGPs
dgp_levels <- c("Empirical\nSparse" = "3",
                 "Simulated\nChain 6N" = "4", "Simulated\nNonsparse" = "5",
                 "Simulated\nChain 8N" = "6")

# Colors and linetypes consistent across plots
cond_colors <- set_names(ggokabeito::palette_okabe_ito()[c(1:5)],
                         c("BGGM narrow", "BGGM wide", "graphicalVAR", "SEL wide", "SEL narrow"))

cond_lty <- set_names(c(1,1,1,1,1),
                      c("BGGM narrow", "BGGM wide", "graphicalVAR", "SEL wide", "SEL narrow"))

```





# Simulation 2
Load results

```{r}
df_comp_res <- readRDS(here::here("output/df_comp_res.RDS"))
```



Plotting parameters
```{r}
change_names <- c("change1.2" = paste("Largest", "\u00D7", "1.2"),
                  "change1.4" = paste("Largest", "\u00D7", "1.4"),
                  "change1.6" = paste("Largest", "\u00D7", "1.6"),
                  "const0.05" = paste("All", "\u00b1", "0.05"),
                  "const0.1" = paste("All", "\u00b1", "0.10"),
                  "const0.15" = paste("All", "\u00b1", "0.15"),
                  "permute" = "Permute"
)

graph_names <- c("Empirical\nSparse" = "graph3",
                 "Simulated\nChain" = "graph4",
                 "Simulated\nNonsparse" = "graph5")

norm_names <- c("frob" = "Frobenius",
                "l1" = "\u2113[1]",
                "maxdiff" = "Maxdiff")

tp_levels <- c("50" = "1", "100" = "2", "200" = "3", "400" = "4", "1000" = "5")

# plotting linetypes
cond_lty <- set_names(c(1,2),
                      c("narrow", "wide"))



# Restructure results for proper plotting
df_comp_res <- df_comp_res %>% 
  mutate(comp = as.factor(comp)) %>% 
  mutate(prior = as.factor(prior)) %>% 
  mutate(comp = forcats::fct_relevel(comp, "l1")) %>% 
  mutate(change = gsub("permute134256", "permute", change)) %>% 
  # delete prior from dgp column
  mutate(dgp = gsub("narrow_", "", dgp))

# Delete old conditions
df_comp_res <- df_comp_res %>% 
  dplyr::filter(!grepl("noise", change))

# write_rds(df_comp_res, here::here("output/df_comp_res.RDS"))

# Number of combinations
n_comp <- 4950

# significance cutoff
sig_cut <- 0.05

# number of posterior draws
n_draw <- 1000
```


## Power
What happens to power/false positives if we implement the following decision rule:
If either A or B are "significant", we have evidence for a difference in the networks.


With uncertainty in the form of standard errors. Focus on some conditions and one performance measure.
```{r}
plot_dec_rule_se_present <- df_comp_res %>% 
          dplyr::filter(dgp %in% c("graph3", "graph4", "graph5")) %>% 
          dplyr::filter(change != "change1.2") %>% 
          dplyr::filter(change != "truegraph") %>% 
          # mutate tp_ind into factor
          dplyr::mutate(tp = as.factor(tp)) %>% 
          dplyr::mutate(tp = forcats::fct_relevel(tp, "50", "100", "200", "400", "1000")) %>% 
          dplyr::mutate(dgp = fct_recode(as_factor(as.character(dgp)), !!!graph_names)) %>% 
          dplyr::mutate(change = case_match(
            change,
                  "change1.2" ~ paste("Largest", "\u00D7", "1.2"),
                  "change1.4" ~ paste("Largest", "\u00D7", "1.4"),
                  "change1.6" ~ paste("Largest", "\u00D7", "1.6"),
                  "const0.05" ~ paste("All", "\u00b1", "0.05"),
                  "const0.1" ~ paste("All", "\u00b1", "0.10"),
                  "const0.15" ~ paste("All", "\u00b1", "0.15"),
                  "permute" ~ "Permute"
          )) %>% 
          dplyr::mutate(change = as.factor(change)) %>% 
          dplyr::mutate(change = forcats::fct_relevel(change, "Largest × 1.4", 
                                                      "Largest × 1.6",
                                                      "All ± 0.05",
                                                      "All ± 0.10",
                                                      "All ± 0.15")) %>% 
          # mutate(change = fct_recode(as_factor(as.character(change)), !!!change_names)) %>% 
          # setup decision rule
          dplyr::mutate(
                 sig_beta05 = ifelse(beta_a < sig_cut*n_draw |
                                       beta_b < sig_cut*n_draw, 
                                     1, 0),
                 sig_pcor05 = ifelse(pcor_a < sig_cut*n_draw |
                                       pcor_b < sig_cut*n_draw, 
                                     1, 0)) %>% 
          dplyr::group_by(dgp, comp, tp, change, prior) %>% 
          dplyr::summarize(
                    power_beta05 = sum(sig_beta05)/n_comp,
                    power_pcor05 = sum(sig_pcor05)/n_comp,
                    se_beta05 = sqrt((power_beta05 * (1-power_beta05))/100),
                    se_pcor05 = sqrt((power_pcor05 * (1-power_pcor05))/100)) %>% 
          tidyr::pivot_longer(cols = c("power_beta05", "power_pcor05"), names_to = "res") %>%
          # attach correct se
          dplyr::mutate(se = ifelse(grepl("beta", res), se_beta05, se_pcor05)) %>% 
          dplyr::select(!c(se_beta05, se_pcor05)) %>% 
          dplyr::mutate(mat = case_when(
            grepl("beta05", res) ~ "Temporal",
            grepl("pcor05", res) ~ "Contemporaneous")) %>% 
          dplyr::ungroup() %>% 
          # for now, only narrow prior
          dplyr::filter(prior == "narrow") %>%
          ## uncomment this to include both priors
          # ggplot(aes(x = tp, y = value, col = comp,
          #            group = interaction(comp, prior), linetype = prior)) +
          
          #--- Changes for presentation
          dplyr::filter(change %in% c("Largest × 1.6", "All ± 0.15")) %>% 
          dplyr::filter(dgp %in% c("Empirical\nSparse", "Simulated\nNonsparse")) %>% 
          #---
          ggplot(aes(x = tp, y = value, col = comp,
                      group = comp)) +
          geom_errorbar(aes(ymin = value - 1.96*se,
                            ymax = value + 1.96*se),
                        width = .8, 
                 position = position_dodge(0.7),
                 show.legend = FALSE)+
          # geom_line()+
          geom_point(size = 1.2, position = position_dodge(0.7))+
          theme_compare()+
          # scale_linetype_manual(values = cond_lty)+
          ggh4x::facet_nested(change ~ dgp + mat,
                              axes = "all",
                              remove_labels = "all"
                              )+
          ggokabeito::scale_colour_okabe_ito()+
          labs(x = "Timepoints",
               y = "Power",
               col = "Norm",
               linetype = "Norm")+
          scale_y_continuous(limits = c(0,1), expand = c(0,0))+
            theme(
                  strip.text = ggplot2::element_text(face = "plain", size = ggplot2::rel(1.2),
                  hjust = 0.5),
                  strip.text.x.top = ggplot2::element_text(face = "plain", size = ggplot2::rel(1.2),
                  hjust = 0.5),
                  legend.text = ggplot2::element_text(face = "plain", size = ggplot2::rel(1.2)),
                  legend.title = ggplot2::element_text(face = "bold", size = ggplot2::rel(1.2)),
                  # panel.border = element_rect(color = "#D5D8DC", fill = NA, size = 1),
                  panel.spacing.y = ggplot2::unit(1.6, "lines"),
                  panel.spacing.x = ggplot2::unit(1.6, "lines"),
                  axis.line = element_line(colour = "#6d6d6e"),
                  axis.text.x = ggplot2::element_text(face = "plain", size = ggplot2::rel(0.95)),
                  axis.title.x = ggplot2::element_text(face = "plain", size = ggplot2::rel(1.3)),
                  axis.title.y = ggplot2::element_text(face = "plain", size = ggplot2::rel(1.3)))

plot_dec_rule_se_present
ggsave(filename = "plot_dec_rule_se_present.svg",plot_dec_rule_se_present, device = "svg", path = here::here("figures/"), width = 14, height = 12)

plot_dec_rule_prior_sens_present <- df_comp_res %>% 
          dplyr::filter(comp == "frob") %>% 
          dplyr::filter(dgp %in% c("graph3", "graph4", "graph5",
                                   "narrow_graph3", "narrow_graph4", "narrow_graph5")) %>% 
          dplyr::filter(change != "change1.2") %>% 
          dplyr::filter(change != "truegraph") %>% 
          mutate(dgp = case_match(dgp,
                                  "narrow_graph3" ~ "graph3",
                                  "narrow_graph4" ~ "graph4",
                                  "narrow_graph5" ~ "graph5",
                                  .default = dgp)) %>% 
          # mutate tp_ind into factor
          mutate(tp = as.factor(tp)) %>% 
          mutate(tp = forcats::fct_relevel(tp, "50", "100", "200", "400", "1000")) %>% 
          # separate graph and prior
          # tidyr::separate_wider_delim(cols = dgp, delim = "_", names = c("prior", "dgp")) %>% 
          mutate(dgp = case_match(dgp,
                                  "graph3" ~ "Empirical Sparse",
                                  "graph4" ~ "Simulated Chain",
                                  "graph5" ~ "Simulated Nonsparse")) %>%
         dplyr::mutate(change = case_match(
            change,
                  "change1.2" ~ paste("Largest", "\u00D7", "1.2"),
                  "change1.4" ~ paste("Largest", "\u00D7", "1.4"),
                  "change1.6" ~ paste("Largest", "\u00D7", "1.6"),
                  "const0.05" ~ paste("All", "\u00b1", "0.05"),
                  "const0.1" ~ paste("All", "\u00b1", "0.10"),
                  "const0.15" ~ paste("All", "\u00b1", "0.15"),
                  "permute" ~ "Permute"
          )) %>% 
          dplyr::mutate(change = as.factor(change)) %>% 
          dplyr::mutate(change = forcats::fct_relevel(change, "Largest × 1.4", 
                                                      "Largest × 1.6",
                                                      "All ± 0.05",
                                                      "All ± 0.10",
                                                      "All ± 0.15")) %>% 
          # setup decision rule
          dplyr::mutate(sig_beta05 = ifelse(beta_a < 50 | beta_b < 50, 1, 0),
                 sig_pcor05 = ifelse(pcor_a < 50 | pcor_b < 50, 1, 0)) %>% 
          dplyr::group_by(dgp, comp, prior, tp, change) %>% 
          dplyr::summarize(
                    power_beta05 = sum(sig_beta05)/n_comp,
                    power_pcor05 = sum(sig_pcor05)/n_comp,
                    se_beta05 = sqrt((power_beta05 * (1-power_beta05))/100),
                    se_pcor05 = sqrt((power_pcor05 * (1-power_pcor05))/100)) %>% 
          tidyr::pivot_longer(cols = c("power_beta05", "power_pcor05"), names_to = "res") %>%
          # attach correct se
          dplyr::mutate(se = ifelse(grepl("beta", res), se_beta05, se_pcor05)) %>% 
          dplyr::select(!c(se_beta05, se_pcor05)) %>% 
          dplyr::mutate(mat = case_when(
            grepl("beta05", res) ~ "Temporal",
            grepl("pcor05", res) ~ "Contemp.")) %>%  
          
          #--- Changes for presentation
          dplyr::filter(change %in% c("Largest × 1.6", "All ± 0.15")) %>% 
          dplyr::filter(dgp %in% c("Empirical Sparse", "Simulated Nonsparse")) %>% 
          #---
          
          ggplot(aes(x = tp, y = value, color = prior, group = prior)) + 
          ggh4x::facet_nested(change ~ dgp + mat,
                              axes = TRUE,
                              remove_labels = TRUE)+
          geom_errorbar(aes(ymin = value - 1.96*se,
                            ymax = value + 1.96*se),
                        width = .8, 
                        position = position_dodge(0.7),
                 show.legend = FALSE)+
          # geom_line()+
          geom_point(size = 1.2, position = position_dodge(0.7))+
          ggokabeito::scale_colour_okabe_ito()+
          theme_compare()+
          labs(x = "Timepoints",
               y = "Power",
               col = "Prior")+
          theme(
                  strip.text = ggplot2::element_text(face = "plain", size = ggplot2::rel(1.2),
                  hjust = 0.5),
                  strip.text.x.top = ggplot2::element_text(face = "plain", size = ggplot2::rel(1.2),
                  hjust = 0.5),
                  legend.text = ggplot2::element_text(face = "plain", size = ggplot2::rel(1.2)),
                  legend.title = ggplot2::element_text(face = "bold", size = ggplot2::rel(1.2)),
                  # panel.border = element_rect(color = "#D5D8DC", fill = NA, size = 1),
                  panel.spacing.y = ggplot2::unit(1.6, "lines"),
                  panel.spacing.x = ggplot2::unit(1.6, "lines"),
                  axis.line = element_line(colour = "#6d6d6e"),
                  axis.text.x = ggplot2::element_text(face = "plain", size = ggplot2::rel(0.95)),
                  axis.title.x = ggplot2::element_text(face = "plain", size = ggplot2::rel(1.3)),
                  axis.title.y = ggplot2::element_text(face = "plain", size = ggplot2::rel(1.3)))


plot_dec_rule_prior_sens_present
ggsave(filename ="plot_dec_rule_prior_sens_present.svg",plot_dec_rule_prior_sens_present, device = "svg",
         path = here::here("figures/"), width = 10, height = 4.5)

```

