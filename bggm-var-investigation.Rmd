---
title: "bggm-var-investigation"
author: "Bj√∂rn Siepe"
date: "2022-11-18"
output: html_document
---
In this file, I investigate some of the properties of BGGM var_estimate. 
Does it actually work well? If so, the following should be true.
1. It should perform regularization as it says.
2. It should recover roughly the same estimate as, e.g., graphicalVAR. 


# Test regularization
```{r}
set.seed(2022)
compgraph <- randomGVARmodel(Nvar = 6, probKappaEdge = 0.4, probBetaEdge = .2)
dat <- as.data.frame(graphicalVARsim(200, beta = compgraph$beta, kappa = graph$kappa))
res <- BGGM::var_estimate(dat,
                          beta_sd = 1)
res2 <- BGGM::var_estimate(dat,
                           beta_sd = 0.1)


# Try the same for rho
res3 <- BGGM::var_estimate(dat,
                          rho_sd = 0.5)
res4 <- BGGM::var_estimate(dat,
                          rho_sd = 0.05)



```

# Compare with GraphicalVAR

For now, just simulate 100 datasets from the same DGP. 
```{r generate-data}
# Storage
l_gvardata <- list()

# Simulation conditions
n_ind <- 200   # number of individuals (so models to create)
n_tp <- 150     # number of timepoints per time series

ncores = parallel::detectCores() - 4
cl = makeCluster(ncores)
registerDoParallel(cl)

l_gvardata <- sim_raw_parallel(dgp = compgraph, n = n_ind, 
                                tp = n_tp, means = 0,
                                standardize = TRUE)

stopCluster(cl)





```

```{r fit-models}
# Model specifics
rho_sd <- 0.5
beta_sd <- 1
seed <- 2022
n_iter <- 5000

l_compres <- list()
ncores = parallel::detectCores() - 4
cl = makeCluster(ncores)
registerDoParallel(cl)

l_compres$bggm <- fit_var_parallel(data = l_gvardata, n = n_ind,
                 rho_prior = rho_sd, beta_prior = beta_sd, seed = seed,
                 iterations = n_iter)

l_compres$gvar <- foreach(i = seq(n_ind), .packages = "graphicalVAR") %dopar% {
  tmp_res <- graphicalVAR(data = l_gvardata[[i]]$data, 
               lambda_beta = 0,
               lambda_kappa = 0, 
               scale = TRUE, 
               gamma = 0)
  
  tmp_res
  
}

stopCluster(cl)


```



Now we can compare the results. What do we look at? Due to no regularization, do not look at true positives/false positives here. 
- difference from data-generating process


TODO: Is it fine not to look at the intercepts? This might be important. 
TODO: Do I need the transpose?
TODO: Add correlations


```{r compare-results}
comp_res <- compare_dgp(true = compgraph, est_bggm = l_compres$bggm, est_gvar = l_compres$gvar, n = 200)


```

Works pretty well for n = 200 and one graph. Default priors seem to be okay, only has convergence issues in some cases.  



